# Lissa Trading Auth Service

**Lissa Trading Auth Service** — это микросервис, основной задачей которого является регистрация и аутентификация
пользователей, а также выдача JWT и Refresh токенов для дальнейшего доступа к другим сервисам. Данные о пользователях
хранятся в базе данных `auth_service_db`.

## Разработка на проекте

- Ветки называем по идентификатору задачи: `feat(STOCK-1)` или `bugfix(STOCK-1)`
- Креды от серверов, баз данных и других ресурсов не прописываем в коде, используем переменные окружения
- Все фичи проверяются локально, покрываются тестами (unit и integration), затем проверяются на сервере, и только после
  этого переводятся в done
- Комментарии к задаче пишем на английском языке с чётким описанием выполненной работы
- Одна ветка — одна задача. Несколько задач в одной ветке не допускаются
- Все сервисы используют одну базу данных с разными схемами
- Схема базы должна называться по имени сервиса, например: `auth_service_db`

## Структура проекта

```text
lissa-trading-auth-service
│
├── src/main/java/lissa/trading/auth/service/
│   ├── aspect/                - Аспекты (AOP) для управления пересекающимися задачами
│   │   └── AuthenticationContextHolder - Утилита для хранения данных аутентификации в потоке
│   │   └── LogEndpointAspect  - Логирование вызовов конечных точек
│   ├── config/                - Файлы конфигурации сервиса
│   │   └── CacheConfig        - Конфигурация кэширования
│   │   └── SwaggerConfig      - Конфигурация Swagger для API документации
│   ├── controller/            - REST API контроллеры
│   │   └── AuthController     - Управление аутентификацией и авторизацией
│   │   └── InternalController - Внутренний API для взаимодействия между сервисами
│   │   └── UserController     - Контроллер для работы с пользователями
│   ├── details/               - Реализация деталей пользователя для безопасности
│   │   └── CustomUserDetails  - Пользовательские детали безопасности
│   │   └── CustomUserDetailsService - Сервис пользовательских деталей
│   ├── exception/             - Обработка исключений
│   │   └── EncryptionTokenException
│   │   └── InvalidRefreshTokenException
│   ├── model/                 - Модели сущностей для базы данных
│   │   └── User               - Сущность пользователя
│   │   └── Role               - Сущность роли пользователя
│   ├── payload/               - Объекты передачи данных (DTO)
│   │   ├── request/           - DTO для входящих запросов
│   │   │   └── LoginRequest   - Запрос для входа пользователя
│   │   │   └── SignupRequest  - Запрос для регистрации пользователя
│   │   ├── response/          - DTO для ответов
│   │   │   └── JwtResponse    - Ответ с JWT токеном
│   │   │   └── UserRegistrationResponse - Ответ при регистрации
│   ├── repository/            - Репозитории для работы с базой данных
│   │   └── UserRepository     - Репозиторий для работы с пользователями
│   │   └── RoleRepository     - Репозиторий для ролей
│   ├── security/              - Конфигурация безопасности
│   │   └── jwt/               - Логика для работы с JWT токенами
│   │   │   └── JwtService     - Сервис для генерации и валидации JWT
│   │   └── internal/          - Внутренние компоненты безопасности
│   │   │   └── InternalTokenFilter  - Фильтр для внутренней обработки токенов
│   │   └── WebSecurityConfig  - Конфигурация безопасности веб-сервисов
│   ├── service/               - Сервисы бизнес-логики
│   │   └── AuthService        - Основной сервис аутентификации
│   │   └── UserService        - Сервис для работы с пользователями
│   └── LissaTradingAuthServiceApplication - Запуск приложения
├── src/main/resources/
│   └── db.changelog/          - Changelog для миграции базы данных
│   └── application.yaml       - Конфигурация уровня приложения (local и prod)
│   └── application-local.yaml - Конфигурация для локальной среды
│   └── application-prod.yaml  - Конфигурация для продакшена
├── Dockerfile                 - Конфигурация Docker для контейнеризации
├── docker-compose.yaml        - Конфигурация для запуска контейнеров
└── pom.xml                    - Файл конфигурации Maven
```

## Назначение сервиса

**Lissa Trading Auth Service** выполняет ключевую роль в обеспечении безопасности системы и управлении пользователями.
Основные функции сервиса:

### Регистрация пользователей

Сервис поддерживает регистрацию новых пользователей через `AuthController` и сохраняет данные в базе данных
`auth_service_db`. При регистрации создается новый пользователь с указанными ролями.

### Аутентификация пользователей

С помощью `AuthController` сервис обрабатывает вход пользователей по логину и паролю. После успешной аутентификации
выдается `JWT` токен для доступа к защищенным ресурсам и `Refresh` токен для обновления сессии.

### Управление токенами

Сервис использует JWT токены для аутентификации запросов. Токены генерируются `JwtService`, проверяются при каждом
запросе с помощью фильтров безопасности, и могут обновляться через эндпоинты обновления токенов.

### Безопасность

Конфигурация безопасности сервиса настроена через `WebSecurityConfig` для защиты всех входящих запросов. Фильтры, такие
как `AuthTokenFilter`, проверяют валидность токенов перед доступом к защищенным ресурсам.

## Kubernetes Deployment

Для развёртывания сервиса в Kubernetes предусмотрены следующие конфигурационные файлы:
`postgres-pv.yaml`, `postgres-deployment.yaml`, `pgadmin-deployment.yaml`, `init-sql.yaml`, `deployment.yaml`,
`service.yaml`.